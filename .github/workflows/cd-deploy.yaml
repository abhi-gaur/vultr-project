name: CD - Deploy

on:
  workflow_run:
    workflows: ["CI - Build & Scan"]
    types:
      - completed

env:
  REGISTRY: blr.vultrcr.com/devopsassignment

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get latest versions
      run: |
        BACKEND_VERSION=$(git tag --list "backend-v*" --sort=-v:refname | head -n1 | sed 's/backend-v//')
        FRONTEND_VERSION=$(git tag --list "frontend-v*" --sort=-v:refname | head -n1 | sed 's/frontend-v//')

        echo "BACKEND_VERSION=$BACKEND_VERSION" >> $GITHUB_ENV
        echo "FRONTEND_VERSION=$FRONTEND_VERSION" >> $GITHUB_ENV

    - name: Setup kubectl
      uses: azure/setup-kubectl@v4

    - name: Write kubeconfig
      run: |
        echo "${{ secrets.KUBECONFIG }}" > kubeconfig
        chmod 600 kubeconfig

    - name: Deploy Backend
      env:
        KUBECONFIG: ${{ github.workspace }}/kubeconfig
      run: |
        kubectl set image deployment/backend \
          backend=$REGISTRY/backend:$BACKEND_VERSION -n app

        kubectl rollout status deployment/backend -n app --timeout=300s

    - name: Deploy Frontend
      env:
        KUBECONFIG: ${{ github.workspace }}/kubeconfig
      run: |
        kubectl set image deployment/frontend \
          frontend=$REGISTRY/frontend:$FRONTEND_VERSION -n app

        kubectl rollout status deployment/frontend -n app --timeout=300s

